---
phase: 07-integration-and-documentation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/api.md
  - docs/architecture.md
  - docs/configuration.md
autonomous: true
requirements: [INTG-04, INTG-05, INTG-06]

must_haves:
  truths:
    - "REST API documentation covers every endpoint with curl examples, request/response JSON, error codes, and authentication requirements"
    - "Architecture guide provides a Mermaid system overview diagram plus per-subsystem deep-dives (registration, consent, routing, discovery, REST API)"
    - "Architecture guide has a dedicated security section covering trust model, consent verification, API key auth, and audit chain integrity"
    - "Configuration reference documents every config option with type, default, description, and NEURON_ env var override name"
    - "All three documents are AI-agent optimized: structured, predictable formatting with consistent heading hierarchy, tables, and code blocks"
  artifacts:
    - path: "docs/api.md"
      provides: "REST API reference documentation"
      contains: "X-API-Key"
    - path: "docs/architecture.md"
      provides: "Architecture guide with Mermaid diagrams"
      contains: "mermaid"
    - path: "docs/configuration.md"
      provides: "Configuration reference with all options and env vars"
      contains: "NEURON_"
  key_links:
    - from: "docs/api.md"
      to: "src/api/openapi-spec.ts"
      via: "Endpoint definitions, status codes, and response schemas extracted from OpenAPI spec"
      pattern: "GET.*POST.*DELETE"
    - from: "docs/architecture.md"
      to: "src/cli/commands/start.ts"
      via: "Startup lifecycle and subsystem orchestration extracted from start command"
      pattern: "registration.*consent.*routing"
    - from: "docs/configuration.md"
      to: "src/types/config.ts"
      via: "Config options extracted from NeuronConfigSchema TypeBox definitions"
      pattern: "organization.*server.*websocket.*storage.*audit"
---

<objective>
Create three operator-facing reference documentation files: REST API reference, architecture guide, and configuration reference.

Purpose: Operators and AI agents need structured, self-contained documentation to deploy, integrate with, and understand the Neuron. All three documents are extracted from the actual codebase (OpenAPI spec, TypeBox schema, start.ts lifecycle) to ensure accuracy. AI-agent optimized formatting per user decision.

Output: `docs/api.md`, `docs/architecture.md`, `docs/configuration.md`
</objective>

<execution_context>
@/Users/medomatic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medomatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-integration-and-documentation/07-CONTEXT.md

# Source files to extract documentation from
@src/api/openapi-spec.ts
@src/api/api-router.ts
@src/types/config.ts
@src/config/defaults.ts
@src/config/loader.ts
@src/cli/commands/start.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create REST API reference documentation</name>
  <files>docs/api.md</files>
  <action>
Create `docs/api.md` -- the REST API reference documentation. Extract all endpoint information from `src/api/openapi-spec.ts` and `src/api/api-router.ts`.

**Document structure (AI-agent optimized):**

1. **Header section:**
   - Title: `# Neuron REST API Reference`
   - Source of truth note: "This document describes the Neuron REST API. The programmatic OpenAPI 3.1 specification is available at `GET /openapi.json`."
   - Base URL: `http://{host}:{port}/v1`

2. **Authentication section:**
   - `X-API-Key` header required on all `/v1/*` endpoints
   - API keys generated via `neuron api-key create --name <name>`
   - Key format: `nrn_` prefix (shown once at creation, only hash stored)
   - Rate limiting: per-key token bucket (configurable via `api.rateLimit`)
   - Table: authentication error codes (401, 429)

3. **Error Format section (centralized):**
   - Standard error response shape: `{ "error": "message" }`
   - Table of common HTTP status codes: 200, 201, 400, 401, 404, 429, 500

4. **Endpoints section (per-endpoint):**
   For each endpoint, provide:
   - HTTP method + path
   - Description
   - Authentication: required / public
   - Request: parameters, headers, body (if applicable)
   - Response: status code, JSON body (full example)
   - Error responses: status codes and conditions
   - Curl example with `-H 'X-API-Key: nrn_...'`

   **Endpoints to document (extract from openapi-spec.ts and api-router.ts):**
   - `GET /v1/organization` -- returns organization info (NPI, name, type)
   - `GET /v1/relationships` -- returns list of relationships (read-only)
   - `GET /v1/relationships/:id` -- returns single relationship by ID
   - `GET /v1/status` -- returns server status (uptime, active sessions, registration)
   - `GET /openapi.json` -- returns OpenAPI 3.1 spec (public, no auth)

5. **Rate Limiting section:**
   - Token bucket algorithm description
   - Headers returned: `X-RateLimit-Limit`, `X-RateLimit-Remaining` (if applicable)
   - 429 response format
   - Configuration via `api.rateLimit.maxRequests` and `api.rateLimit.windowMs`

6. **CORS section:**
   - Configurable allowed origins via `api.cors.allowedOrigins`
   - Preflight OPTIONS handling
   - Headers: `Access-Control-Allow-Origin`, `Access-Control-Allow-Methods`, `Access-Control-Allow-Headers`

**Formatting rules (AI-agent optimized per user decision):**
- Every section has a predictable format (no prose-only sections)
- Code examples are complete and copy-pasteable
- Tables for structured data (endpoints, error codes, config)
- Consistent H2 for sections, H3 for subsections, H4 for individual endpoints
- No ambiguity -- explicit types and values
- Reference source of truth file at the top

**Read `src/api/openapi-spec.ts` and `src/api/api-router.ts` during implementation** to extract exact paths, methods, response shapes, and status codes. Do NOT write from memory -- extract from code.
  </action>
  <verify>
File exists at `docs/api.md`. Contains sections for every endpoint. Curl examples include `-H 'X-API-Key: nrn_...'`. Error format section exists. Rate limiting and CORS documented.
  </verify>
  <done>REST API reference exists with every endpoint documented including curl examples, request/response JSON, error codes, authentication, rate limiting, and CORS. AI-agent optimized formatting with consistent structure.</done>
</task>

<task type="auto">
  <name>Task 2: Create architecture guide and configuration reference</name>
  <files>docs/architecture.md, docs/configuration.md</files>
  <action>
Create two documentation files:

**A. `docs/architecture.md` -- Architecture Guide**

Extract from `src/cli/commands/start.ts` (lifecycle orchestration), module structure, and inter-module dependency graph.

**Document structure:**

1. **Overview section:**
   - What the Neuron is: organizational boundary node in the CareAgent network
   - Core principle: routes connections, verifies consent, never holds clinical data
   - Mermaid diagram: high-level system overview showing Neuron's position between Patient CareAgents, Provider CareAgents, and the Axon network directory. Include: WebSocket connections, Axon registration, mDNS discovery, REST API.

2. **Subsystem Architecture section:**
   For each subsystem, provide a brief description, key files, and a Mermaid diagram showing internal flow:

   a. **Registration** (Axon integration):
      - AxonRegistrationService orchestrates AxonClient, RegistrationStateStore, HeartbeatManager
      - Startup: register org -> register providers -> start heartbeat
      - Mermaid: registration lifecycle flow

   b. **Consent Verification:**
      - Ed25519 consent tokens, ConsentHandshakeHandler, challenge-response protocol
      - Stateless re-verification on every connection (CSNT-02)
      - Mermaid: consent handshake message flow

   c. **WebSocket Routing:**
      - NeuronProtocolServer, broker-and-step-out model
      - Connection flow: upgrade -> auth -> consent verify -> challenge -> complete -> disconnect
      - Safety ceiling with queuing
      - Mermaid: WebSocket handshake sequence

   d. **Local Discovery:**
      - mDNS/DNS-SD via bonjour-service
      - Service type `_careagent-neuron._tcp` with TXT records
      - Same consent flow as remote (DISC-04)

   e. **REST API:**
      - HTTP server shared with WebSocket (request vs upgrade events)
      - API key auth, rate limiting, CORS
      - Route dispatch via manual matching (no framework)

3. **Startup Lifecycle section:**
   - Exact initialization order from start.ts: config -> storage -> audit -> IPC -> registration -> relationships -> WebSocket -> REST -> discovery -> Axon registration
   - Mermaid: startup sequence diagram
   - Shutdown order: discovery -> WebSocket -> registration -> IPC -> storage

4. **Data Flow section:**
   - Mermaid diagram showing data flow for a patient connection: Patient CareAgent -> WebSocket -> Consent Verify -> Challenge-Response -> Address Exchange -> Disconnect
   - Mermaid diagram showing REST API data flow: Client -> API Key Auth -> Rate Limit -> Route Handler -> Store Query -> Response

5. **Security section (dedicated per user decision):**
   - **Trust model:** Neuron trusts consent tokens signed by patient CareAgents, verified with Ed25519. No cached trust (stateless re-verification).
   - **Consent verification:** Ed25519 token format, signature verification, expiration checks
   - **API key authentication:** `nrn_` prefix, SHA-256 hash storage, timing-safe comparison
   - **Audit chain integrity:** Hash-chained JSONL, SHA-256, deterministic serialization, genesis entry with 64-zero prev_hash
   - **Network security:** All WebSocket communication is JSON text envelopes (no binary), challenge-response prevents replay attacks

6. **IPC Protocol section:**
   - Unix domain socket with NDJSON protocol
   - Command types: provider.add, provider.remove, provider.list, status, relationship.terminate

**B. `docs/configuration.md` -- Configuration Reference**

Extract from `src/types/config.ts` (NeuronConfigSchema) and `src/config/defaults.ts` (DEFAULT_CONFIG).

**Document structure:**

1. **Overview section:**
   - Config file: `neuron.config.json` (default path, overridable with `--config`)
   - Generated via `neuron init`
   - Environment variable overrides: `NEURON_` prefix, `__` for nesting (e.g., `NEURON_SERVER__PORT=8080`)
   - Env vars are case-insensitive for key resolution

2. **Configuration Categories:**
   For each category, provide a table with columns: Key, Type, Default, Description, Env Var Override

   Categories (from NeuronConfigSchema):
   a. **organization** -- `npi` (string, required), `name` (string, required), `type` (string, required)
   b. **server** -- `port` (number, default 3000), `host` (string, default '0.0.0.0')
   c. **websocket** -- `path`, `maxConcurrentHandshakes`, `authTimeoutMs`, `queueTimeoutMs`, `maxPayloadBytes`
   d. **storage** -- `path` (string, default './data/neuron.db')
   e. **audit** -- `path` (string), `enabled` (boolean)
   f. **localNetwork** -- `enabled` (boolean), `serviceType` (string), `protocolVersion` (string)
   g. **heartbeat** -- `intervalMs` (number)
   h. **axon** -- `registryUrl` (string), `endpointUrl` (string), `backoffCeilingMs` (number)
   i. **api** -- `rateLimit.maxRequests`, `rateLimit.windowMs`, `cors.allowedOrigins`

3. **Example Configurations:**
   - Minimal config (only required fields)
   - Full config (all options with defaults shown)

4. **Environment Variable Override section:**
   - Pattern: `NEURON_{SECTION}__{KEY}` (double underscore for nesting)
   - Examples table showing env var -> config path mapping
   - Case-insensitive resolution behavior

5. **Validation Rules section:**
   - NPI must be valid 10-digit Luhn-checked number
   - Port must be valid number
   - Required fields that must be present

**Read `src/types/config.ts` and `src/config/defaults.ts` during implementation** to extract exact field names, types, and defaults. Do NOT write from memory.

**Formatting rules (same AI-agent optimized approach for both docs):**
- Consistent H2/H3/H4 hierarchy
- Tables for structured data
- Mermaid diagrams for all visual flows (architecture.md)
- Code blocks for config examples and commands
- Reference source of truth files at the top of each document
- Cross-references between docs use relative links (e.g., "See [Configuration Reference](./configuration.md)")
  </action>
  <verify>
Files exist at `docs/architecture.md` and `docs/configuration.md`. Architecture guide has Mermaid diagrams (search for triple-backtick mermaid blocks). Architecture guide has a Security section. Configuration reference has tables for every config category. Both documents have consistent formatting.
  </verify>
  <done>Architecture guide exists with Mermaid diagrams for system overview, per-subsystem deep-dives, startup lifecycle, data flow, and dedicated security section. Configuration reference exists with every config option documented in tables by category, env var overrides, example configs, and validation rules. Both are AI-agent optimized.</done>
</task>

</tasks>

<verification>
1. `docs/api.md` exists with all endpoints documented
2. `docs/architecture.md` exists with Mermaid diagrams and security section
3. `docs/configuration.md` exists with all config options and env var overrides
4. All three documents follow consistent AI-agent optimized formatting
5. No references to non-existent features or incorrect paths
</verification>

<success_criteria>
- REST API reference covers every endpoint with curl examples and error codes
- Architecture guide has system overview Mermaid diagram plus per-subsystem deep-dives
- Architecture guide has dedicated security section
- Configuration reference covers every config option with type, default, and env var
- All documents are self-contained (no assumed prior context)
- All documents are AI-agent optimized with predictable, structured formatting
</success_criteria>

<output>
After completion, create `.planning/phases/07-integration-and-documentation/07-03-SUMMARY.md`
</output>
