---
phase: 07-integration-and-documentation
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - tests/e2e-discovery.test.ts
  - tests/e2e-rest-api.test.ts
autonomous: true
requirements: [INTG-02, INTG-03]

must_haves:
  truths:
    - "E2E test passes: Neuron advertises via mDNS, browser discovers service, TXT records contain NPI and endpoint, WebSocket connection via discovered endpoint completes consent handshake"
    - "E2E test passes: API key created, authenticated requests return correct data, unauthenticated requests get 401, rate limit exhaustion returns 429"
    - "mDNS discovery test uses real bonjour-service browser, not mocks"
    - "REST API test uses real HTTP requests against the running Neuron"
  artifacts:
    - path: "tests/e2e-discovery.test.ts"
      provides: "mDNS discovery E2E test validating ROADMAP SC-2"
      contains: "describe.*discovery"
    - path: "tests/e2e-rest-api.test.ts"
      provides: "REST API E2E test validating ROADMAP SC-3"
      contains: "describe.*REST API"
  key_links:
    - from: "tests/e2e-discovery.test.ts"
      to: "tests/helpers/neuron-harness.ts"
      via: "import NeuronTestHarness with enableDiscovery: true"
      pattern: "enableDiscovery.*true"
    - from: "tests/e2e-discovery.test.ts"
      to: "bonjour-service"
      via: "mDNS browser to discover advertised _careagent-neuron._tcp service"
      pattern: "browser\\.find.*careagent-neuron"
    - from: "tests/e2e-rest-api.test.ts"
      to: "tests/helpers/neuron-harness.ts"
      via: "import NeuronTestHarness with low rate limit config"
      pattern: "maxRequests.*3"
    - from: "tests/e2e-rest-api.test.ts"
      to: "http://127.0.0.1:{port}/v1/*"
      via: "fetch() for authenticated REST API requests"
      pattern: "fetch.*127\\.0\\.0\\.1.*v1"
---

<objective>
Create E2E tests for local mDNS discovery flow and REST API with rate limiting.

Purpose: Validates ROADMAP Phase 7 Success Criteria 2 and 3: mDNS discovery through consent-verified connection, and REST API key creation with rate limiting enforcement. These tests reuse the NeuronTestHarness from Plan 01.

Output: `tests/e2e-discovery.test.ts`, `tests/e2e-rest-api.test.ts`
</objective>

<execution_context>
@/Users/medomatic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medomatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-integration-and-documentation/07-RESEARCH.md
@.planning/phases/07-integration-and-documentation/07-01-SUMMARY.md

# Source files for test patterns
@src/discovery/service.ts
@src/api/openapi-spec.ts
@src/api/api-router.ts
@tests/helpers/neuron-harness.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mDNS discovery E2E test</name>
  <files>tests/e2e-discovery.test.ts</files>
  <action>
Create the local discovery E2E test validating ROADMAP Phase 7 Success Criterion 2:
> "E2E test passes: local mDNS discovery through consent-verified connection"

**Test structure:**

```typescript
describe('E2E: Local mDNS Discovery', () => {
  let harness: NeuronTestHarness

  beforeAll(async () => {
    harness = new NeuronTestHarness()
    await harness.start({ enableDiscovery: true })
  }, 20000)  // Extended timeout for mDNS startup

  afterAll(async () => {
    await harness.stop()
  }, 10000)

  // Tests below
})
```

**Test cases:**

1. **"Neuron advertises _careagent-neuron._tcp via mDNS"**
   - Create a `Bonjour` browser instance (from `bonjour-service`)
   - Browse for service type `careagent-neuron` (matching `config.localNetwork.serviceType`)
   - Use a Promise with 10-second timeout wrapping `browser.find()`
   - Assert service is found
   - Extract TXT records: verify `npi` matches org NPI, `ver` matches protocol version, `ep` contains the WebSocket endpoint URL
   - Clean up browser with `browser.destroy()`

2. **"connects via discovered endpoint and completes consent handshake"**
   - After discovering the endpoint URL from the TXT `ep` record in test 1, connect via WebSocket to the discovered endpoint
   - Generate test key pair, create valid consent claims, sign consent token
   - Complete the full handshake flow (auth -> challenge -> response -> complete)
   - Assert `type === 'handshake.complete'` and `relationship_id` exists
   - This proves DISC-04: local connections use the same consent verification flow as remote connections

**Implementation notes:**
- Import `Bonjour` from `bonjour-service` (default export)
- The mDNS browser callback fires for each discovered service. Use `browser.find({ type: 'careagent-neuron' }, callback)`. The returned browser object has a `.stop()` method.
- Use `{ timeout: 15000 }` on individual tests since mDNS has inherent latency (1-2 seconds on macOS)
- The harness with `enableDiscovery: true` will configure `localNetwork.enabled: true` and start the DiscoveryService
- Store the discovered endpoint URL from test 1 for use in test 2 (shared variable in describe scope)
- If mDNS discovery is unreliable in the test environment, the test may need to be skipped. Add a comment about this but do NOT pre-skip it -- let it run.

**Key pitfall avoidance (from research):**
- mDNS browser needs time to discover. Use a poll/retry loop with 10-second overall timeout.
- Clean up the Bonjour instance in afterAll to prevent hanging.
  </action>
  <verify>
Run `npx vitest run tests/e2e-discovery.test.ts` -- all tests pass. Verify the test actually discovers a real mDNS service (not mocked) and connects via the discovered endpoint.
  </verify>
  <done>mDNS discovery E2E test passes: Neuron advertises via mDNS, browser discovers service with correct TXT records, connection via discovered endpoint completes consent handshake. ROADMAP SC-2 validated.</done>
</task>

<task type="auto">
  <name>Task 2: Create REST API E2E test</name>
  <files>tests/e2e-rest-api.test.ts</files>
  <action>
Create the REST API E2E test validating ROADMAP Phase 7 Success Criterion 3:
> "E2E test passes: REST API key creation with rate limiting enforcement"

**Test structure:**

```typescript
describe('E2E: REST API', () => {
  let harness: NeuronTestHarness
  let apiKeyRaw: string

  beforeAll(async () => {
    harness = new NeuronTestHarness()
    await harness.start({
      rateLimit: { maxRequests: 3, windowMs: 60000 }  // Low limit, long window
    })

    // Create API key for testing
    const keyResult = harness.apiKeyStore.create('e2e-test-key')
    apiKeyRaw = keyResult.raw
  })

  afterAll(async () => {
    await harness.stop()
  })

  // Tests below
})
```

**Test cases:**

1. **"GET /v1/organization returns org data with valid API key"**
   - `fetch(`http://127.0.0.1:${harness.port}/v1/organization`, { headers: { 'X-API-Key': apiKeyRaw } })`
   - Assert status 200
   - Assert response JSON has `npi` matching config org NPI, has `name`, has `type`

2. **"GET /v1/relationships returns empty array initially"**
   - `fetch(`http://127.0.0.1:${harness.port}/v1/relationships`, { headers: { 'X-API-Key': apiKeyRaw } })`
   - Assert status 200
   - Assert response is an array (may be empty)

3. **"GET /v1/status returns server status"**
   - `fetch(`http://127.0.0.1:${harness.port}/v1/status`, { headers: { 'X-API-Key': apiKeyRaw } })`
   - Assert status 200
   - Assert response has expected status fields

4. **"GET /openapi.json returns valid OpenAPI spec without auth"**
   - `fetch(`http://127.0.0.1:${harness.port}/openapi.json`)` -- NO API key header
   - Assert status 200
   - Assert response JSON has `openapi: '3.1.0'`, has `info.title`, has `paths`

5. **"requests without API key receive 401"**
   - `fetch(`http://127.0.0.1:${harness.port}/v1/organization`)` -- NO API key header
   - Assert status 401
   - Assert response body has `error` field

6. **"requests with invalid API key receive 401"**
   - `fetch(..., { headers: { 'X-API-Key': 'nrn_invalid_key_12345' } })`
   - Assert status 401

7. **"rate limiting returns 429 after token exhaustion"**
   - Create a SECOND API key (the first may have been partially consumed by earlier tests)
   - Exhaust all 3 tokens in a tight loop:
     ```typescript
     const freshKey = harness.apiKeyStore.create('rate-limit-test')
     for (let i = 0; i < 3; i++) {
       const r = await fetch(`http://127.0.0.1:${harness.port}/v1/status`, {
         headers: { 'X-API-Key': freshKey.raw }
       })
       expect(r.status).toBe(200)
     }
     ```
   - Immediately make one more request -- assert status 429
   - Assert response body has `error` field mentioning rate limit

8. **"CORS preflight returns correct headers for allowed origin"**
   - Send an OPTIONS request with `Origin: http://localhost:3000` and `Access-Control-Request-Method: GET`
   - Assert response includes `Access-Control-Allow-Origin` header
   - Note: CORS behavior depends on config `api.cors.allowedOrigins: ['*']`

**Key patterns:**
- Use native `fetch()` for all HTTP requests (available in Node 18+)
- Create a fresh API key for rate limit testing to avoid interference from earlier tests consuming tokens
- Rate limit window is 60 seconds -- zero refills during test execution
- The harness configures `maxRequests: 3` for fast rate limit exhaustion
  </action>
  <verify>
Run `npx vitest run tests/e2e-rest-api.test.ts` -- all tests pass. Verify: authenticated requests succeed, unauthenticated get 401, rate limit exhaustion gets 429, OpenAPI spec accessible without auth.
  </verify>
  <done>REST API E2E test passes: API key authentication works, all endpoints respond correctly, rate limiting enforces 429, CORS works, OpenAPI spec is public. ROADMAP SC-3 validated.</done>
</task>

</tasks>

<verification>
1. `npx vitest run tests/e2e-discovery.test.ts` passes
2. `npx vitest run tests/e2e-rest-api.test.ts` passes
3. `npx vitest run tests/` passes (all E2E tests together)
4. `npx vitest run src/` still passes (existing unit/integration tests unaffected)
</verification>

<success_criteria>
- mDNS discovery E2E validates real service advertisement and consent-verified connection
- REST API E2E validates auth, rate limiting, CORS, and all endpoints
- Both tests use NeuronTestHarness from Plan 01
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-integration-and-documentation/07-02-SUMMARY.md`
</output>
