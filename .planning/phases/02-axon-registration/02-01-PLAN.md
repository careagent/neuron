---
phase: 02-axon-registration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/config.ts
  - src/types/registration.ts
  - src/types/index.ts
  - src/config/defaults.ts
  - src/storage/migrations.ts
  - test/mock-axon/server.ts
  - test/mock-axon/start.ts
autonomous: true
requirements: [NREG-05, NREG-07]

must_haves:
  truths:
    - "A Neuron initialized from config has registration tables that Plans 02-02 and 02-03 can read and write without schema errors"
    - "Plans 02-02 and 02-04 can read axon.registryUrl, axon.endpointUrl, and axon.backoffCeilingMs from NeuronConfig without type errors"
    - "Registration and heartbeat tests can start a standalone mock Axon server and exercise the full Axon API contract"
  artifacts:
    - path: "src/types/registration.ts"
      provides: "TypeBox schemas for NeuronRegistrationState and ProviderRegistration"
      exports: ["NeuronRegistrationStateSchema", "NeuronRegistrationState", "ProviderRegistrationSchema", "ProviderRegistration", "NeuronRegistrationStatus", "ProviderRegistrationStatus"]
    - path: "src/storage/migrations.ts"
      provides: "Migration v2 with neuron_registration and provider_registrations tables"
      contains: "neuron_registration"
    - path: "test/mock-axon/server.ts"
      provides: "Standalone mock Axon HTTP server"
      exports: ["createMockAxonServer"]
    - path: "test/mock-axon/start.ts"
      provides: "Entry point to launch mock Axon as child process"
  key_links:
    - from: "src/types/registration.ts"
      to: "src/types/common.ts"
      via: "imports NpiString, IsoDateString"
      pattern: "import.*NpiString.*from.*common"
    - from: "src/storage/migrations.ts"
      to: "src/types/registration.ts"
      via: "migration v2 SQL matches TypeBox schema fields"
      pattern: "neuron_registration"
---

<objective>
Create the data model foundation and mock Axon server for Phase 2.

Purpose: All subsequent registration plans depend on TypeBox schemas, SQLite persistence tables, and the mock Axon server for testing. This plan establishes all three.

Output: Registration TypeBox schemas, extended NeuronConfig with `axon` section, SQLite migration v2 with registration tables, and a standalone mock Axon HTTP server.
</objective>

<execution_context>
@/Users/medomatic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medomatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-axon-registration/02-RESEARCH.md

@src/types/common.ts
@src/types/config.ts
@src/types/index.ts
@src/config/defaults.ts
@src/storage/migrations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Registration TypeBox schemas, config extension, and SQLite migration v2</name>
  <files>
    src/types/registration.ts
    src/types/config.ts
    src/types/index.ts
    src/config/defaults.ts
    src/storage/migrations.ts
  </files>
  <action>
1. Create `src/types/registration.ts` with TypeBox schemas:
   - `ProviderRegistrationStatus`: Union of `'pending' | 'registered' | 'failed'`
   - `ProviderRegistrationSchema`: Object with `provider_npi` (NpiString), `axon_provider_id` (Optional String), `registration_status` (ProviderRegistrationStatus), `first_registered_at` (Optional IsoDateString), `last_heartbeat_at` (Optional IsoDateString), `last_axon_response_at` (Optional IsoDateString)
   - `NeuronRegistrationStatus`: Union of `'unregistered' | 'pending' | 'registered' | 'suspended'`
   - `NeuronRegistrationStateSchema`: Object with `organization_npi` (NpiString), `organization_name` (String), `organization_type` (String), `axon_registry_url` (String), `neuron_endpoint_url` (String), `registration_id` (Optional String), `axon_bearer_token` (Optional String), `status` (NeuronRegistrationStatus), `first_registered_at` (Optional IsoDateString), `last_heartbeat_at` (Optional IsoDateString), `last_axon_response_at` (Optional IsoDateString), `providers` (Array of ProviderRegistrationSchema)
   - Export all schemas, status unions, and Static types
   - Import `NpiString`, `IsoDateString` from `./common.js`
   - Follow established naming: PascalCase with Schema suffix

2. Extend `NeuronConfigSchema` in `src/types/config.ts`:
   - Add `axon` section as `Type.Object({ registryUrl: Type.String({ default: 'http://localhost:9999' }), endpointUrl: Type.String({ default: 'http://localhost:3000' }), backoffCeilingMs: Type.Number({ minimum: 1000, default: 300000 }) })`
   - This adds the config fields needed by CONTEXT.md: Axon registry URL, Neuron endpoint URL, backoff ceiling (default 5 min)

3. Update `src/config/defaults.ts`:
   - Add `axon: { registryUrl: 'http://localhost:9999', endpointUrl: 'http://localhost:3000', backoffCeilingMs: 300000 }` to DEFAULT_CONFIG

4. Update `src/types/index.ts`:
   - Add barrel exports for all new registration types and schemas

5. Add migration v2 to `src/storage/migrations.ts`:
   - Append to the `migrations` array a version 2 entry with description 'Create registration tables: neuron_registration, provider_registrations'
   - SQL creates:
     ```sql
     CREATE TABLE IF NOT EXISTS neuron_registration (
       id INTEGER PRIMARY KEY CHECK (id = 1),
       organization_npi TEXT NOT NULL,
       organization_name TEXT NOT NULL,
       organization_type TEXT NOT NULL,
       axon_registry_url TEXT NOT NULL,
       neuron_endpoint_url TEXT NOT NULL,
       registration_id TEXT,
       axon_bearer_token TEXT,
       status TEXT NOT NULL DEFAULT 'unregistered',
       first_registered_at TEXT,
       last_heartbeat_at TEXT,
       last_axon_response_at TEXT
     );
     CREATE TABLE IF NOT EXISTS provider_registrations (
       provider_npi TEXT PRIMARY KEY,
       axon_provider_id TEXT,
       registration_status TEXT NOT NULL DEFAULT 'pending',
       first_registered_at TEXT,
       last_heartbeat_at TEXT,
       last_axon_response_at TEXT
     );
     ```
   - The `id INTEGER PRIMARY KEY CHECK (id = 1)` on neuron_registration enforces single-row (one org per Neuron)
   - Per user decision: Store both Axon-assigned registration_id AND organization_npi. Per-provider independent status tracking (pending/registered/failed). Full timestamps: first_registered_at, last_heartbeat_at, last_axon_response_at.
  </action>
  <verify>
    Run `pnpm build` to confirm TypeBox schemas compile. Run `pnpm test` to confirm existing tests still pass (migration runner should handle v2 gracefully since existing tests use in-memory DBs that run all migrations fresh).
  </verify>
  <done>
    - `src/types/registration.ts` exports NeuronRegistrationStateSchema, ProviderRegistrationSchema, and all status types
    - `NeuronConfigSchema` has an `axon` section with registryUrl, endpointUrl, backoffCeilingMs
    - DEFAULT_CONFIG includes axon defaults
    - Migration v2 creates neuron_registration (single-row enforced) and provider_registrations tables
    - All existing tests pass, build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Standalone mock Axon HTTP server</name>
  <files>
    test/mock-axon/server.ts
    test/mock-axon/start.ts
  </files>
  <action>
1. Create `test/mock-axon/server.ts`:
   - Import `http` from `node:http` and `randomUUID` from `node:crypto`
   - Export `createMockAxonServer(port: number): http.Server` function
   - Use in-memory `Map` for state (fresh per run per Claude's Discretion â€” optimize for test reliability)
   - Implement these happy-path-only routes (per locked decision: no failure mode simulation):
     - `POST /v1/neurons`: Accept `{ organization_npi, organization_name, organization_type, neuron_endpoint_url }`, generate `registration_id` via `randomUUID()`, generate `bearer_token` as `mock-token-${id}`, store in neurons Map, return `201` with `{ registration_id, bearer_token, status: 'reachable' }`
     - `PUT /v1/neurons/:id/endpoint`: Accept `{ neuron_endpoint_url }`, validate neuron exists (404 if not), update status to `'reachable'`, return `200` with `{ status: 'reachable' }`
     - `POST /v1/neurons/:id/providers`: Accept `{ provider_npi }`, validate neuron exists (404 if not), generate `provider_id` via `randomUUID()`, store provider, return `201` with `{ provider_id, status: 'registered' }`
     - `DELETE /v1/neurons/:id/providers/:npi`: Validate neuron exists (404 if not), remove provider, return `204`
     - `GET /v1/neurons/:id`: Return the neuron's full state including providers array (useful for test assertions)
     - Default: return `404` with `{ error: 'not found' }`
   - All routes parse URL with `new URL(req.url!, ...)` and use regex matching for path params
   - Set `Content-Type: application/json` on all responses
   - Per locked decision: Axon is actively being built in parallel; this mock defines what Neuron expects

2. Create `test/mock-axon/start.ts`:
   - Parse `--port` from process.argv (default 9999)
   - Import and call `createMockAxonServer(port)`
   - Listen on port, print `mock-axon ready on port ${port}` to stdout when listening (this is the ready signal for test harnesses)
   - Handle SIGINT/SIGTERM for clean shutdown

Note: Do NOT install MSW yet. MSW will be installed later when unit tests need it (Plan 02). This task only creates the standalone mock server process.
  </action>
  <verify>
    Start the mock server manually: `npx tsx test/mock-axon/start.ts --port 19999`. In another terminal, test with curl:
    - `curl -s -X POST http://localhost:19999/v1/neurons -H 'Content-Type: application/json' -d '{"organization_npi":"1234567893","organization_name":"Test","organization_type":"practice","neuron_endpoint_url":"http://localhost:3000"}'` should return 201 with registration_id and bearer_token
    - Kill the mock server process after verification
  </verify>
  <done>
    - Mock Axon server starts as standalone Node.js process (separate from Neuron per locked decision)
    - Responds to all 5 routes: register neuron, heartbeat/endpoint update, register provider, remove provider, get neuron
    - Happy path only (no failure simulation per locked decision)
    - Fresh in-memory state per run
    - Prints ready signal on stdout for test harness integration
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds with no type errors
2. `pnpm test` passes all existing tests (68 tests from Phase 1)
3. Mock Axon starts and responds to curl requests on all 5 endpoints
4. TypeBox schemas in `src/types/registration.ts` export correctly via barrel
5. Migration v2 creates both tables when running against a fresh database
</verification>

<success_criteria>
- Registration TypeBox schemas are importable from `@careagent/neuron` (via barrel export)
- NeuronConfig schema includes `axon` section with three configurable fields
- SQLite migration v2 creates `neuron_registration` (single-row enforced) and `provider_registrations` tables
- Mock Axon server starts independently and handles registration protocol
- All existing Phase 1 tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-axon-registration/02-01-SUMMARY.md`
</output>
