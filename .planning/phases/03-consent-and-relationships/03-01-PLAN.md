---
phase: 03-consent-and-relationships
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/types/relationship.ts
  - src/storage/migrations.ts
  - src/consent/errors.ts
  - src/consent/token.ts
  - src/consent/verifier.ts
  - src/consent/index.ts
  - src/consent/consent.test.ts
autonomous: true
requirements:
  - CSNT-01
  - CSNT-02
  - CSNT-03
  - CSNT-04

must_haves:
  truths:
    - "A valid Ed25519 consent token is verified successfully and returns parsed claims"
    - "An expired consent token is rejected with CONSENT_EXPIRED error code"
    - "A tampered consent token is rejected with INVALID_SIGNATURE error code"
    - "Malformed token payload is rejected with MALFORMED_TOKEN error code"
    - "Consent verifier is stateless -- no cached trust between calls"
    - "Consent scope (consented_actions) is extracted and returned without interpretation"
  artifacts:
    - path: "src/consent/verifier.ts"
      provides: "Ed25519 consent token verification"
      exports: ["verifyConsentToken", "importPublicKey"]
    - path: "src/consent/errors.ts"
      provides: "Typed consent error codes"
      exports: ["ConsentError", "ConsentErrorCode"]
    - path: "src/consent/token.ts"
      provides: "Consent token type definitions"
      exports: ["ConsentToken", "ConsentClaims"]
    - path: "src/consent/index.ts"
      provides: "Public barrel exports"
    - path: "src/types/relationship.ts"
      provides: "Updated schema with patient_public_key"
      contains: "patient_public_key"
    - path: "src/storage/migrations.ts"
      provides: "Migration v3 adding patient_public_key column"
      contains: "version: 3"
  key_links:
    - from: "src/consent/verifier.ts"
      to: "node:crypto"
      via: "crypto.verify(null, payload, publicKey, signature)"
      pattern: "verify\\(null,"
    - from: "src/consent/verifier.ts"
      to: "src/consent/errors.ts"
      via: "throws ConsentError with typed codes"
      pattern: "throw new ConsentError"
---

<objective>
Build the Ed25519 consent token verification subsystem and update the relationship schema for public key storage.

Purpose: Consent verification is the trust gate for all communication through the Neuron. Every connection requires cryptographic proof of patient consent. This plan establishes the stateless verification primitive that all downstream handlers depend on.

Output: ConsentVerifier module with TDD-proven Ed25519 verification, typed error codes, and updated RelationshipRecord schema with patient_public_key field.
</objective>

<execution_context>
@/Users/medomatic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medomatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-consent-and-relationships/03-RESEARCH.md

@src/types/relationship.ts
@src/types/common.ts
@src/storage/migrations.ts
@src/storage/interface.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update RelationshipRecord schema and add SQLite migration v3</name>
  <files>src/types/relationship.ts, src/storage/migrations.ts</files>
  <action>
    1. In `src/types/relationship.ts`, add `patient_public_key: Type.String()` to `RelationshipRecordSchema`. Place it after `consented_actions` and before `created_at`. This stores the base64url-encoded Ed25519 public key for re-verification on every connection (CSNT-02).

    2. In `src/storage/migrations.ts`, add migration v3:
    ```
    {
      version: 3,
      description: 'Add patient_public_key to relationships table',
      up: `ALTER TABLE relationships ADD COLUMN patient_public_key TEXT NOT NULL DEFAULT '';`,
    }
    ```
    The `DEFAULT ''` is required because SQLite ALTER TABLE ADD COLUMN requires a default for existing rows. No relationship records exist yet (Phase 3 creates them), so the empty default is safe. Application-layer enforcement ensures all new records have a real public key value.
  </action>
  <verify>
    - `npx vitest run src/storage/sqlite.test.ts` passes (migrations still work)
    - `npx tsc --noEmit` passes (type check)
  </verify>
  <done>
    RelationshipRecord TypeBox schema includes patient_public_key field. Migration v3 exists and adds the column to the relationships table.
  </done>
</task>

<feature>
  <name>Task 2: ConsentVerifier with Ed25519 token verification (TDD)</name>
  <files>src/consent/errors.ts, src/consent/token.ts, src/consent/verifier.ts, src/consent/index.ts, src/consent/consent.test.ts</files>
  <behavior>
    ConsentVerifier is a set of pure functions with no internal state. It:

    1. `importPublicKey(rawKeyBase64url: string): KeyObject` -- Imports an Ed25519 public key from base64url-encoded raw 32 bytes via JWK format: `createPublicKey({ key: { kty: 'OKP', crv: 'Ed25519', x: rawKeyBase64url }, format: 'jwk' })`.

    2. `verifyConsentToken(token: ConsentToken, publicKey: KeyObject): ConsentClaims` -- Verifies an Ed25519 signature over the token payload, parses JSON claims, checks expiration.

    Cases:
    - Valid token (not expired, valid signature) -> returns ConsentClaims with patient_agent_id, provider_npi, consented_actions, iat, exp
    - Expired token (exp < now) -> throws ConsentError with code 'CONSENT_EXPIRED'
    - Tampered signature -> throws ConsentError with code 'INVALID_SIGNATURE'
    - Non-JSON payload -> throws ConsentError with code 'MALFORMED_TOKEN'
    - Consented actions extracted as-is, not validated (CSNT-04)
    - Each call is fully independent -- no cached trust (CSNT-02)

    Types:
    - `ConsentToken`: `{ payload: Buffer, signature: Buffer }`
    - `ConsentClaims`: `{ patient_agent_id: string, provider_npi: string, consented_actions: string[], exp: number, iat: number, nonce?: string }`
    - `ConsentErrorCode`: `'INVALID_SIGNATURE' | 'CONSENT_EXPIRED' | 'MALFORMED_TOKEN'`
    - `ConsentError extends Error`: has `code: ConsentErrorCode` and `name: 'ConsentError'`
  </behavior>
  <implementation>
    Create four source files:

    **src/consent/errors.ts**: `ConsentErrorCode` type union and `ConsentError` class extending Error with `code` property and `name = 'ConsentError'`.

    **src/consent/token.ts**: `ConsentToken` interface (payload: Buffer, signature: Buffer) and `ConsentClaims` interface. Use plain TypeScript interfaces, not TypeBox (these are runtime crypto types, not persistence schemas).

    **src/consent/verifier.ts**: Two exported functions:
    - `importPublicKey(rawKeyBase64url)` -- uses `createPublicKey` from `node:crypto` with JWK format `{ kty: 'OKP', crv: 'Ed25519', x: rawKeyBase64url }`.
    - `verifyConsentToken(token, publicKey)` -- (1) call `verify(null, token.payload, publicKey, token.signature)`, throw INVALID_SIGNATURE if false; (2) `JSON.parse(token.payload.toString('utf-8'))`, throw MALFORMED_TOKEN on parse error; (3) check `claims.exp <= Math.floor(Date.now() / 1000)`, throw CONSENT_EXPIRED if true; (4) return claims. CRITICAL: algorithm parameter MUST be `null` for Ed25519 (not 'sha256' or 'ed25519').

    **src/consent/index.ts**: Re-export all public types and functions from errors.ts, token.ts, verifier.ts.

    **src/consent/consent.test.ts**: Use `generateKeyPairSync('ed25519')` to create test keys. Test helper `makeToken(claims, privateKey)` signs claims JSON bytes with `sign(null, payload, privateKey)`. Test cases:
    - Valid token returns correct claims
    - Expired token throws ConsentError with code CONSENT_EXPIRED
    - Tampered signature throws ConsentError with code INVALID_SIGNATURE
    - Non-JSON payload throws ConsentError with code MALFORMED_TOKEN
    - consented_actions are returned as-is (array of arbitrary strings)
    - importPublicKey correctly imports from base64url
  </implementation>
</feature>

</tasks>

<verification>
- `npx vitest run src/consent/` -- all consent tests pass
- `npx tsc --noEmit` -- no type errors
- `npx vitest run` -- all existing tests still pass
</verification>

<success_criteria>
- Ed25519 consent token verification works with valid, expired, tampered, and malformed tokens
- ConsentError carries typed error codes for downstream error handling
- Verifier is stateless -- no cached trust, no internal state
- consented_actions passed through without Neuron interpretation (CSNT-04)
- RelationshipRecord schema includes patient_public_key
- Migration v3 adds patient_public_key column to relationships table
- All tests pass including existing Phase 1 and Phase 2 tests
</success_criteria>

<output>
After completion, create `.planning/phases/03-consent-and-relationships/03-01-SUMMARY.md`
</output>
