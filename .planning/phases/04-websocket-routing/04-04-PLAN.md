---
phase: 04-websocket-routing
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/ROADMAP.md
  - src/routing/handler.ts
  - src/routing/routing.test.ts
autonomous: true
gap_closure: true
requirements:
  - ROUT-01
  - ROUT-02
  - ROUT-03
  - ROUT-04
  - ROUT-05
  - ROUT-06

must_haves:
  truths:
    - "ROADMAP Phase 4 SC-2 describes the broker-and-step-out address exchange model (not a relay bridge)"
    - "ROADMAP Phase 4 SC-3 describes the global handshake ceiling with queuing (not per-provider rejection)"
    - "Early consent token verification failure emits connection.handshake_failed audit event"
    - "No dead code in routing.test.ts activeSessions test"
  artifacts:
    - path: ".planning/ROADMAP.md"
      provides: "Updated Phase 4 Success Criteria SC-2 and SC-3"
      contains: "address exchange"
    - path: "src/routing/handler.ts"
      provides: "Audit event for early consent failure path"
      contains: "handshake_failed"
    - path: "src/routing/routing.test.ts"
      provides: "Clean activeSessions test without dead code"
  key_links:
    - from: "src/routing/handler.ts"
      to: "src/audit/logger.ts"
      via: "auditLogger.append in early consent failure catch block"
      pattern: "handshake_failed"
---

<objective>
Close verification gaps from Phase 4 verification report. Two documentation gaps (ROADMAP Success Criteria SC-2 and SC-3 describe the original relay model instead of the implemented broker-and-step-out model) and two minor code gaps (missing audit event on early consent failure, dead test variable).

Purpose: Bring ROADMAP documentation into alignment with the implemented architecture and ensure complete audit trail coverage.
Output: Updated ROADMAP.md, handler.ts with complete audit coverage, clean routing.test.ts
</objective>

<execution_context>
@/Users/medomatic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medomatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/04-websocket-routing/04-VERIFICATION.md
@src/routing/handler.ts
@src/routing/routing.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update ROADMAP Phase 4 Success Criteria SC-2 and SC-3</name>
  <files>.planning/ROADMAP.md</files>
  <action>
In `.planning/ROADMAP.md`, find the Phase 4 Success Criteria section. Update two items:

**SC-2 (currently line 87):** Replace:
```
2. Messages flow bidirectionally between patient and provider through the session bridge with backpressure handling (no unbounded memory growth)
```
With:
```
2. After consent verification and challenge-response, the Neuron completes the address exchange (patient receives provider_endpoint, relationship recorded) and closes the connection — the broker-and-step-out model with connection queuing prevents unbounded memory growth
```

**SC-3 (currently line 88):** Replace:
```
3. Per-provider concurrency limits are enforced; the 11th simultaneous connection to a provider with limit 10 is rejected with a clear error
```
With:
```
3. A global handshake safety ceiling (configurable maxConcurrentHandshakes, default 10) queues connections beyond the limit rather than rejecting them; queued connections are promoted as slots open or time out gracefully
```

Do NOT change SC-1, SC-4, or SC-5. Do NOT change any other phase's content.
  </action>
  <verify>Read the updated ROADMAP.md Phase 4 section and confirm:
- SC-2 mentions "address exchange" and "broker-and-step-out"
- SC-3 mentions "global handshake safety ceiling" and "queues" (not "rejected")
- SC-1, SC-4, SC-5 are unchanged
- No other phases are modified</verify>
  <done>ROADMAP Phase 4 Success Criteria SC-2 and SC-3 accurately describe the broker-and-step-out architecture with global handshake ceiling and queuing</done>
</task>

<task type="auto">
  <name>Task 2: Add missing handshake_failed audit event and remove dead test code</name>
  <files>src/routing/handler.ts, src/routing/routing.test.ts</files>
  <action>
**Part A — Add audit event in handler.ts:**

In `src/routing/handler.ts`, find the early consent token verification catch block (around lines 178-187). After `session.status = 'failed'` and before `ws.close(4003, ...)`, add a `handshake_failed` audit event matching the existing pattern at line 339-350:

```typescript
if (auditLogger) {
  auditLogger.append({
    category: 'connection',
    action: 'connection.handshake_failed',
    actor: authMsg.patient_agent_id,
    details: {
      session_id: session.id,
      error: err instanceof Error ? err.message : 'Unknown error',
      provider_npi: 'unknown',
    },
  })
}
```

Use `'unknown'` for `provider_npi` because the early consent failure occurs before provider NPI is successfully extracted. Place the audit emit BEFORE the `ws.close()` call (consistent with audit-before-close pattern).

**Part B — Remove dead test code in routing.test.ts:**

In `src/routing/routing.test.ts`, find lines 497-504 (the dead `challenge` variable block). Remove the entire block:

```typescript
    // Complete handshake
    const challenge = await new Promise<Record<string, unknown>>((resolve) => {
      // We already got the challenge above, so re-read from stored message
      // Actually, we need to get the nonce. The handler already sent the challenge.
      // Since we consumed it above, we need to use the nonce from the challenge message.
      // Let me restructure: the challenge was already received in the line above.
      resolve({}) // Placeholder; we'll sign with the nonce from the ws1 challenge
    })
```

Leave the surrounding code intact (the `// Close connection to clean up` section that follows).

**Part C — Update the audit test expectation:**

In `src/routing/routing.test.ts`, find the "should emit audit events for handshake flow" test (around lines 608-628). The test currently has comments noting that `handshake_failed` is NOT emitted for early consent failure. Update the test to:
1. Remove the comment noting the gap (lines 609-611)
2. Add an assertion that `handshake_failed` IS now emitted after the `handshake_started` assertion:

```typescript
    // handshake_failed should be emitted for early consent verification failure
    const failed = entries.find(
      (e) => e.action === 'connection.handshake_failed' &&
        (e as Record<string, unknown>).actor === 'patient-fail-audit',
    )
    expect(failed).toBeDefined()
```

Run `npx vitest run src/routing/routing.test.ts` to confirm all tests pass.
  </action>
  <verify>
1. `npx vitest run src/routing/routing.test.ts` — all tests pass
2. `npx tsc --noEmit` — zero TypeScript errors
3. Grep for `handshake_failed` in handler.ts — should appear in TWO locations (early consent failure AND challenge-response failure)
4. Grep for `resolve({})` in routing.test.ts — should return zero results (dead code removed)
  </verify>
  <done>
- Early consent token verification failure emits `connection.handshake_failed` audit event
- Dead `challenge` variable removed from routing.test.ts
- Test updated to assert `handshake_failed` is emitted on early consent failure
- All tests pass, TypeScript compiles clean
  </done>
</task>

</tasks>

<verification>
1. Read ROADMAP.md Phase 4 SC-2 and SC-3 — text matches broker-and-step-out architecture
2. `npx vitest run src/routing/routing.test.ts` — all 14+ tests pass
3. `npx tsc --noEmit` — zero errors
4. Grep `handshake_failed` in handler.ts — found in 2 locations
5. Grep `resolve({})` in routing.test.ts — not found
6. `npx vitest run` — full test suite passes (no regressions)
</verification>

<success_criteria>
- ROADMAP Phase 4 SC-2 describes address exchange and broker-and-step-out model
- ROADMAP Phase 4 SC-3 describes global handshake ceiling with queuing, not per-provider rejection
- handler.ts emits connection.handshake_failed audit event on early consent token failure
- routing.test.ts has no dead code blocks
- All tests pass, TypeScript compiles clean
</success_criteria>

<output>
After completion, create `.planning/phases/04-websocket-routing/04-04-SUMMARY.md`
</output>
