---
phase: 06-rest-api
plan: 02
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - src/api/router.ts
  - src/api/routes/organization.ts
  - src/api/routes/relationships.ts
  - src/api/routes/status.ts
  - src/api/routes/openapi.ts
  - src/api/openapi-spec.ts
  - src/api/index.ts
  - src/api/api-router.test.ts
autonomous: true
requirements:
  - TAPI-01
  - TAPI-04
  - TAPI-05
  - TAPI-06

must_haves:
  truths:
    - "GET /v1/organization returns org name, NPI, and type for authenticated requests"
    - "GET /v1/relationships returns paginated relationship list for authenticated requests"
    - "GET /v1/relationships/:id returns a single relationship record"
    - "GET /v1/status returns Neuron operational status for authenticated requests"
    - "GET /openapi.json returns valid OpenAPI 3.1 spec without requiring auth"
    - "Requests without X-API-Key header receive 401"
    - "Requests exceeding rate limit receive 429 with Retry-After header"
    - "CORS preflight OPTIONS returns 204 with correct headers for allowed origins"
    - "Requests from disallowed origins get no Access-Control-Allow-Origin header"
    - "Unknown paths return 404 with { error: 'Not found' }"
  artifacts:
    - path: "src/api/router.ts"
      provides: "Main request handler with auth, CORS, rate limiting, route dispatch"
      exports: ["createApiRouter", "ApiRouterDeps"]
    - path: "src/api/routes/organization.ts"
      provides: "GET /v1/organization handler"
      exports: ["handleOrganization"]
    - path: "src/api/routes/relationships.ts"
      provides: "GET /v1/relationships and GET /v1/relationships/:id handlers"
      exports: ["handleRelationships", "handleRelationshipById"]
    - path: "src/api/routes/status.ts"
      provides: "GET /v1/status handler"
      exports: ["handleStatus"]
    - path: "src/api/routes/openapi.ts"
      provides: "GET /openapi.json handler"
      exports: ["handleOpenApi"]
    - path: "src/api/openapi-spec.ts"
      provides: "OpenAPI 3.1 specification object"
      exports: ["openapiSpec"]
  key_links:
    - from: "src/api/router.ts"
      to: "src/api/keys.ts"
      via: "ApiKeyStore.verify for auth"
      pattern: "apiKeyStore\\.verify"
    - from: "src/api/router.ts"
      to: "src/api/rate-limiter.ts"
      via: "TokenBucketRateLimiter.consume"
      pattern: "rateLimiter\\.consume"
    - from: "src/api/routes/relationships.ts"
      to: "src/relationships/store.ts"
      via: "RelationshipStore queries"
      pattern: "relationshipStore\\.find"
    - from: "src/api/routes/organization.ts"
      to: "src/types/config.ts"
      via: "NeuronConfig.organization"
      pattern: "config\\.organization"
---

<objective>
Build the REST API router with authentication, rate limiting, CORS, all route handlers, and OpenAPI 3.1 specification.

Purpose: This is the core of Phase 6 -- the actual HTTP API that third-party applications consume. Attaches to the existing HTTP server from NeuronProtocolServer (TAPI-01), protects all endpoints with API key auth (TAPI-02 verify path), enforces CORS (TAPI-04), serves organization/relationships/status data (TAPI-05), and provides OpenAPI documentation (TAPI-06).

Output: Complete REST API router with 5 endpoints, inline auth/CORS/rate-limit pipeline, and comprehensive tests.
</objective>

<execution_context>
@/Users/medomatic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medomatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-rest-api/06-RESEARCH.md
@.planning/phases/06-rest-api/06-01-SUMMARY.md
@src/routing/server.ts
@src/relationships/store.ts
@src/types/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: API router with auth, CORS, rate limiting pipeline and route handlers</name>
  <files>
    src/api/router.ts
    src/api/routes/organization.ts
    src/api/routes/relationships.ts
    src/api/routes/status.ts
    src/api/routes/openapi.ts
    src/api/openapi-spec.ts
    src/api/index.ts
  </files>
  <action>
**Router (`src/api/router.ts`):**

Create `ApiRouterDeps` interface:
```typescript
interface ApiRouterDeps {
  config: NeuronConfig
  apiKeyStore: ApiKeyStore
  rateLimiter: TokenBucketRateLimiter
  relationshipStore: RelationshipStore
  registrationService: AxonRegistrationService
  protocolServer: NeuronProtocolServer
}
```

Create `createApiRouter(deps: ApiRouterDeps)` that returns `(req: IncomingMessage, res: ServerResponse) => void`.

The returned handler follows the EXACT Axon pattern (sequential inline checks, NOT middleware chain):

1. **Parse URL** using `new URL(req.url ?? '', \`http://\${req.headers.host}\`)`. Extract `pathname` and `searchParams`.

2. **Ignore non-API paths** — if pathname does not start with `/v1/` and is not `/openapi.json`, return without handling (let other listeners handle or fall through). This prevents conflict with WebSocket upgrade paths.

3. **CORS headers FIRST** (before any auth/error) — call `setCorsHeaders(res, req, deps.config.api.cors)`:
   - Check `Origin` header against `deps.config.api.cors.allowedOrigins`
   - If origin is in allowed list, set: `Access-Control-Allow-Origin: {origin}`, `Access-Control-Allow-Methods: GET, OPTIONS`, `Access-Control-Allow-Headers: X-API-Key, Content-Type`, `Access-Control-Max-Age: 86400`
   - If `allowedOrigins` contains `'*'`, set `Access-Control-Allow-Origin: *`
   - If origin is not allowed, do NOT set any CORS headers (browser will block)
   - For `OPTIONS` request: `res.writeHead(204)`, `res.end()`, return early

4. **Public endpoint check** — if `pathname === '/openapi.json'`: serve spec, return early (no auth needed)

5. **Auth check** — extract `X-API-Key` header (case-insensitive via `req.headers['x-api-key']`):
   - Missing: `sendJson(res, 401, { error: 'Missing API key' })`, return
   - Invalid (verify returns undefined): `sendJson(res, 401, { error: 'Invalid API key' })`, return

6. **Rate limit check** — `deps.rateLimiter.consume(keyRecord.key_id)`:
   - If false: `res.setHeader('Retry-After', String(deps.rateLimiter.retryAfter(keyRecord.key_id)))`, `sendJson(res, 429, { error: 'Rate limit exceeded' })`, return

7. **Route dispatch** — sequential regex matching (Axon pattern):
   - `GET /v1/organization` → `handleOrganization(res, deps)`
   - `GET /v1/relationships` → `handleRelationships(res, deps, searchParams)`
   - `GET /v1/relationships/:id` → `handleRelationshipById(res, deps, id)` (regex: `/^\/v1\/relationships\/([^/]+)$/`)
   - `GET /v1/status` → `handleStatus(res, deps)`
   - Default: `sendJson(res, 404, { error: 'Not found' })`

   For non-GET methods on valid paths: `sendJson(res, 404, { error: 'Not found' })` (all endpoints are read-only GET per locked decision)

Wrap the entire handler in try/catch: `sendJson(res, 500, { error: 'Internal server error' })` on unexpected errors.

**Route handler: organization (`src/api/routes/organization.ts`):**

`handleOrganization(res, deps)`:
```typescript
const { config, registrationService } = deps
const status = registrationService.getStatus()
sendJson(res, 200, {
  npi: config.organization.npi,
  name: config.organization.name,
  type: config.organization.type,
  axon_status: status.neuron?.status ?? 'unregistered',
  providers: status.providers?.length ?? 0,
})
```

**Route handler: relationships (`src/api/routes/relationships.ts`):**

`handleRelationships(res, deps, searchParams)`:
- Extract optional query params: `status`, `provider_npi`, `offset` (default 0), `limit` (default 50, max 100)
- Query `deps.relationshipStore` based on filters:
  - If `status` provided: `findByStatus(status)`
  - If `provider_npi` provided: `findByProvider(provider_npi)`
  - Otherwise: `storage.all('SELECT * FROM relationships ORDER BY created_at DESC')`
- Apply offset/limit pagination on results
- Map records to API response (exclude `patient_public_key` -- internal field):
  ```typescript
  {
    relationship_id, patient_agent_id, provider_npi,
    status, consented_actions, created_at, updated_at
  }
  ```
- Return: `sendJson(res, 200, { data: mapped, total, offset, limit })`

`handleRelationshipById(res, deps, id)`:
- `deps.relationshipStore.findById(id)`
- If not found: `sendJson(res, 404, { error: 'Relationship not found' })`
- Map record (exclude `patient_public_key`)
- Return: `sendJson(res, 200, mapped)`

**Route handler: status (`src/api/routes/status.ts`):**

`handleStatus(res, deps)`:
```typescript
const regStatus = deps.registrationService.getStatus()
const sessions = deps.protocolServer.activeSessions()
sendJson(res, 200, {
  status: 'running',
  uptime_seconds: Math.floor(process.uptime()),
  organization: {
    npi: deps.config.organization.npi,
    name: deps.config.organization.name,
  },
  axon: {
    status: regStatus.neuron?.status ?? 'unregistered',
  },
  active_sessions: sessions.length,
  providers: regStatus.providers?.length ?? 0,
})
```

**Route handler: openapi (`src/api/routes/openapi.ts`):**

`handleOpenApi(res, openapiSpec)`:
- `sendJson(res, 200, openapiSpec)`

**OpenAPI spec (`src/api/openapi-spec.ts`):**

Hand-written OpenAPI 3.1 spec object:
```typescript
export const openapiSpec = {
  openapi: '3.1.0',
  info: {
    title: 'Neuron REST API',
    version: '1.0.0',
    description: 'Third-party access to Neuron operational data',
  },
  servers: [{ url: '/v1' }],
  security: [{ apiKey: [] }],
  components: {
    securitySchemes: {
      apiKey: {
        type: 'apiKey',
        in: 'header',
        name: 'X-API-Key',
      },
    },
    schemas: { /* response schemas for each endpoint */ },
  },
  paths: {
    '/organization': { get: { /* summary, responses */ } },
    '/relationships': { get: { /* summary, parameters (status, provider_npi, offset, limit), responses */ } },
    '/relationships/{id}': { get: { /* summary, parameters, responses */ } },
    '/status': { get: { /* summary, responses */ } },
  },
}
```

Include response schemas for 200, 401, 404, 429 status codes. Document all query parameters for relationships endpoint (status, provider_npi, offset, limit).

**Update barrel export (`src/api/index.ts`):**
Add exports for router, route handlers, and openapi spec.
  </action>
  <verify>
`pnpm run lint` passes (TypeScript compilation). All route handler files exist and export expected functions.
  </verify>
  <done>
Router dispatches to 5 endpoints with inline auth/CORS/rate-limiting pipeline. Organization, relationships, status, and openapi.json endpoints return correct data. CORS headers set for allowed origins. Non-API paths ignored. Unknown paths return 404.
  </done>
</task>

<task type="auto">
  <name>Task 2: REST API router tests</name>
  <files>
    src/api/api-router.test.ts
  </files>
  <action>
**Test file (`src/api/api-router.test.ts`):**

Create comprehensive tests for the router and all endpoints. Use Node.js `http` module to create a test server with the router attached, make requests with `fetch` (Node 20+ built-in).

**Test setup:**
- Create in-memory SQLite storage, run migrations
- Create ApiKeyStore, generate a test key
- Create TokenBucketRateLimiter with known limits (e.g., 5 requests/10s for easy testing)
- Create RelationshipStore, seed 2-3 test relationships
- Mock AxonRegistrationService.getStatus() to return known state
- Mock NeuronProtocolServer.activeSessions() to return known sessions
- Create router via `createApiRouter(deps)`
- Start HTTP server on port 0, get assigned port
- afterAll: close server and storage

**Auth tests:**
1. Request without X-API-Key header returns 401 `{ error: 'Missing API key' }`
2. Request with invalid API key returns 401 `{ error: 'Invalid API key' }`
3. Request with revoked API key returns 401 `{ error: 'Invalid API key' }`
4. Request with valid API key returns 200

**Rate limiting tests:**
5. Requests within rate limit succeed
6. Requests exceeding rate limit return 429 with Retry-After header and `{ error: 'Rate limit exceeded' }`

**CORS tests:**
7. OPTIONS request from allowed origin returns 204 with CORS headers
8. OPTIONS request from disallowed origin returns 204 but NO Access-Control-Allow-Origin
9. GET request from allowed origin includes CORS headers in response
10. GET request with no Origin header still works (no CORS headers set)

**Organization endpoint:**
11. `GET /v1/organization` returns org npi, name, type, axon_status, providers count

**Relationships endpoint:**
12. `GET /v1/relationships` returns paginated list of relationships
13. `GET /v1/relationships?status=active` filters by status
14. `GET /v1/relationships?limit=1&offset=1` paginates correctly
15. `GET /v1/relationships/:id` returns single relationship
16. `GET /v1/relationships/:id` with unknown ID returns 404

**Status endpoint:**
17. `GET /v1/status` returns running status, uptime, org info, session count

**OpenAPI endpoint:**
18. `GET /openapi.json` returns valid OpenAPI 3.1 spec (check openapi field === '3.1.0')
19. `GET /openapi.json` does NOT require API key authentication

**404 handling:**
20. `GET /v1/unknown` returns 404 `{ error: 'Not found' }`
21. `POST /v1/organization` returns 404 (only GET allowed)
22. `GET /some/random/path` is NOT handled by API router (no response -- path doesn't start with /v1/ or /openapi.json)

**Response format:**
23. All responses have Content-Type: application/json
24. Error responses follow `{ error: "message" }` format
  </action>
  <verify>
`pnpm test -- src/api/api-router.test.ts` — all tests pass.
  </verify>
  <done>
Comprehensive test coverage for auth pipeline (401 for missing/invalid/revoked keys), rate limiting (429 with Retry-After), CORS (preflight and cross-origin), all 5 endpoints (organization, relationships list/detail, status, openapi.json), 404 handling, and response format.
  </done>
</task>

</tasks>

<verification>
- `pnpm test` passes (all existing + new tests)
- `pnpm run lint` passes
- All 5 endpoints return correct data for authenticated requests
- Auth rejects missing/invalid keys with 401
- Rate limiter returns 429 with Retry-After when exhausted
- CORS correctly allows/blocks based on origin config
- OpenAPI spec is publicly accessible
- Response format matches Axon pattern: `{ error: "message" }` for errors
</verification>

<success_criteria>
- createApiRouter returns a request handler attachable to HTTP server
- Inline auth/CORS/rate-limit pipeline (no middleware framework)
- 5 endpoints: organization, relationships, relationships/:id, status, openapi.json
- Axon-consistent patterns: sendJson, regex route matching, error format
- Full test coverage for auth, rate limiting, CORS, all endpoints
</success_criteria>

<output>
After completion, create `.planning/phases/06-rest-api/06-02-SUMMARY.md`
</output>
