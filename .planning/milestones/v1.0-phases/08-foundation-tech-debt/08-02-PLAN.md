---
phase: 08-foundation-tech-debt
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cli/commands/verify-audit.ts
  - src/cli/index.ts
autonomous: true
requirements: [AUDT-03]
must_haves:
  truths:
    - "`neuron verify-audit` reports chain integrity status for the audit log"
    - "Valid chain exits 0 with entry count; corrupted chain exits 1 with error details"
    - "Custom path via `--path` flag overrides config-derived audit path"
  artifacts:
    - path: "src/cli/commands/verify-audit.ts"
      provides: "verify-audit CLI command"
      contains: "verifyAuditChain"
    - path: "src/cli/index.ts"
      provides: "verify-audit command registration"
      contains: "registerVerifyAuditCommand"
  key_links:
    - from: "src/cli/commands/verify-audit.ts"
      to: "src/audit/verifier.ts"
      via: "verifyAuditChain function call"
      pattern: "verifyAuditChain"
    - from: "src/cli/index.ts"
      to: "src/cli/commands/verify-audit.ts"
      via: "import and register"
      pattern: "registerVerifyAuditCommand"
---

<objective>
Add `neuron verify-audit` CLI command that runs audit chain integrity verification.

Purpose: Close tech debt gap from v1.0 milestone audit — `verifyAuditChain()` exists but has no CLI entry point (AUDT-03).
Output: New `neuron verify-audit` command with `--path` and `--config` options, human-readable output, and CI-friendly exit codes.
</objective>

<execution_context>
@/Users/medomatic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medomatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-foundation-tech-debt/08-CONTEXT.md

@src/audit/verifier.ts
@src/audit/index.ts
@src/cli/index.ts
@src/cli/output.ts
@src/cli/commands/status.ts
@src/cli/cli.test.ts
@src/config/loader.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create verify-audit CLI command</name>
  <files>
    src/cli/commands/verify-audit.ts
    src/cli/index.ts
  </files>
  <action>
  1. **Create verify-audit command** (`src/cli/commands/verify-audit.ts`):
     - Export `registerVerifyAuditCommand(program: Command): void`
     - Command name: `verify-audit`
     - Description: `Verify audit log chain integrity`
     - Options:
       - `-c, --config <path>` (default: `'neuron.config.json'`) — config file path to derive audit log location
       - `-p, --path <path>` — explicit audit log file path (overrides config)
     - Action logic:
       (a) Resolve audit path: if `--path` provided, use it directly. Otherwise, load config via `loadConfig(options.config)` and use `config.audit.path`. If config load fails AND no `--path` provided, print error and exit 1.
       (b) Call `verifyAuditChain(auditPath)` from `../../audit/index.js`
       (c) Print results:
         - If `result.entries === 0`: `output.info('Audit log is empty (no entries)')` — exit 0
         - If `result.valid`: `output.success('Audit chain verified: ${result.entries} entries, chain intact')` — exit 0
         - If `!result.valid`: `output.error('Audit chain BROKEN')`, then for each error: `output.error('  Line ${e.line}: ${e.error}')`, then `output.info('${result.entries} entries checked, ${result.errors.length} error(s) found')` — exit 1
     - Import: `Command` from `commander`, `verifyAuditChain` from `../../audit/index.js`, `loadConfig` from `../../config/index.js`, `output` from `../output.js`

  2. **Register in CLI entry point** (`src/cli/index.ts`):
     - Add import: `import { registerVerifyAuditCommand } from './commands/verify-audit.js'`
     - Add registration: `registerVerifyAuditCommand(program)` after `registerApiKeyCommand(program)`

  3. **Add unit tests** (`src/cli/cli.test.ts`):
     - Add mock for audit module at the top of the test file (alongside existing mocks):
       ```typescript
       vi.mock('../audit/index.js', () => ({
         AuditLogger: vi.fn(),
         verifyAuditChain: vi.fn(),
         canonicalize: vi.fn(),
       }))
       ```
     - Import `registerVerifyAuditCommand` in the imports at the top
     - Add `registerVerifyAuditCommand(program)` to the `createProgram()` helper
     - Add `describe('verify-audit command', ...)` with 4 tests:

       (a) `should report valid chain`: mock `verifyAuditChain` to return `{ valid: true, entries: 5, errors: [] }`, create a valid config file, parse `['node', 'neuron', 'verify-audit', '--config', configPath]`, verify stdout contains 'Audit chain verified' and '5 entries'

       (b) `should report broken chain`: mock `verifyAuditChain` to return `{ valid: false, entries: 3, errors: [{ line: 2, error: 'Hash mismatch' }] }`, parse with config, verify stderr contains 'Audit chain BROKEN' and 'Hash mismatch', verify `process.exit` called with 1

       (c) `should use --path flag to override config`: mock `verifyAuditChain` to return `{ valid: true, entries: 1, errors: [] }`, parse `['node', 'neuron', 'verify-audit', '--path', '/tmp/custom-audit.jsonl']`, verify `verifyAuditChain` was called with '/tmp/custom-audit.jsonl'

       (d) `should report empty audit log`: mock `verifyAuditChain` to return `{ valid: true, entries: 0, errors: [] }`, parse with `--path`, verify stdout contains 'empty'

     - Follow existing test patterns: `vi.spyOn(process, 'exit')`, `vi.spyOn(process.stdout, 'write')`, `vi.spyOn(process.stderr, 'write')`, `vi.waitFor`
  </action>
  <verify>
  Run: `npx vitest run src/cli/cli.test.ts`
  All tests pass including new verify-audit tests. Help output includes 'verify-audit'.
  Run: `npx vitest run`
  All existing tests continue to pass.
  </verify>
  <done>
  `neuron verify-audit` command registered in CLI. Uses `verifyAuditChain()` from audit module. Supports `--config` and `--path` flags. Exits 0 on valid/empty chain, exits 1 on broken chain with detailed error output. Four unit tests cover valid, broken, custom path, and empty scenarios.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run` — all tests pass
2. `grep "verify-audit" src/cli/index.ts` confirms registration
3. `grep "verifyAuditChain" src/cli/commands/verify-audit.ts` confirms verifier usage
4. Help output includes verify-audit command
</verification>

<success_criteria>
- `neuron verify-audit` runs `verifyAuditChain()` and reports chain integrity
- `--path` flag allows specifying custom audit log path
- `--config` flag derives audit path from config (default: neuron.config.json)
- Exit code 0 on valid/empty chain, exit code 1 on integrity failure
- Broken chain output includes line numbers and error descriptions
- All existing tests continue to pass
- Four new unit tests cover all branches
</success_criteria>

<output>
After completion, create `.planning/phases/08-foundation-tech-debt/08-02-SUMMARY.md`
</output>
