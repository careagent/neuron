---
phase: 01-foundation
plan: 04
type: execute
wave: 3
depends_on: [02, 03]
files_modified:
  - src/cli/index.ts
  - src/cli/commands/init.ts
  - src/cli/commands/start.ts
  - src/cli/commands/stop.ts
  - src/cli/commands/status.ts
  - src/cli/output.ts
  - src/cli/cli.test.ts
  - bin/neuron
autonomous: true
requirements:
  - FOUN-06
must_haves:
  truths:
    - "Running `neuron start` with a valid config loads configuration, initializes storage, starts audit logger, and reports ready"
    - "Running `neuron start` with an invalid config fails with a clear error and non-zero exit code"
    - "Running `neuron init` generates a starter neuron.config.json interactively"
    - "All four commands (init, start, stop, status) are registered and show in help output"
    - "CLI output follows a consistent format with no emojis"
  artifacts:
    - path: "src/cli/index.ts"
      provides: "Commander.js program setup and entry point"
      exports: ["program"]
    - path: "src/cli/commands/start.ts"
      provides: "Start command: load config, init storage, start audit"
      exports: ["startCommand"]
    - path: "src/cli/commands/init.ts"
      provides: "Init command: generate starter config"
      exports: ["initCommand"]
    - path: "src/cli/output.ts"
      provides: "Consistent CLI output formatting"
      exports: ["output"]
    - path: "bin/neuron"
      provides: "CLI executable entry point"
  key_links:
    - from: "src/cli/commands/start.ts"
      to: "src/config/loader.ts"
      via: "calls loadConfig to load and validate configuration"
      pattern: "import.*loadConfig"
    - from: "src/cli/commands/start.ts"
      to: "src/storage/sqlite.ts"
      via: "creates SqliteStorage and calls initialize()"
      pattern: "import.*SqliteStorage"
    - from: "src/cli/commands/start.ts"
      to: "src/audit/logger.ts"
      via: "creates AuditLogger for startup audit entry"
      pattern: "import.*AuditLogger"
    - from: "src/cli/index.ts"
      to: "src/cli/commands/*.ts"
      via: "registers all commands with Commander program"
      pattern: "program\\.command"
---

<objective>
Wire the CLI entry point with Commander.js, connecting config loading, storage initialization, and audit logging into the `neuron start` command.

Purpose: The CLI is the user-facing surface that ties all foundation components together. `neuron start` exercises the full startup pipeline: load config (Plan 02) -> initialize storage (Plan 03) -> start audit logger (Plan 03) -> report ready. `neuron init` provides a zero-friction onboarding path. This plan delivers the final Phase 1 success criteria: a working CLI with stub commands.

Output: A functional CLI with four commands where `neuron start` performs the complete validated startup sequence.
</objective>

<execution_context>
@/Users/medomatic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medomatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: CLI framework setup with Commander.js and all four commands</name>
  <files>
    src/cli/index.ts
    src/cli/commands/init.ts
    src/cli/commands/start.ts
    src/cli/commands/stop.ts
    src/cli/commands/status.ts
    src/cli/output.ts
    bin/neuron
  </files>
  <action>
    Set up the Commander.js CLI framework with all four stub commands.

    **src/cli/output.ts:**
    Create consistent output helpers (no emojis, clean formatting):
    ```typescript
    export const output = {
      info(message: string): void    // stdout, plain text
      success(message: string): void // stdout, prefixed with checkmark-free "OK:"
      error(message: string): void   // stderr, prefixed with "Error:"
      warn(message: string): void    // stderr, prefixed with "Warning:"
      table(data: Record<string, string>[]): void  // simple key-value table
    }
    ```
    All output uses `process.stdout.write` / `process.stderr.write` for testability. No colors, no emojis -- clean text output.

    **src/cli/commands/init.ts:**
    Export a function that registers the `init` command on a Commander program:
    - Description: "Initialize a new Neuron configuration"
    - Option: `--output, -o <path>` (default: `neuron.config.json`)
    - Action:
      1. Check if config file already exists -- if so, warn and ask to overwrite (for now, just warn and exit)
      2. Generate a starter `neuron.config.json` with placeholder values:
         - organization.npi: "0000000000" (placeholder)
         - organization.name: "My Organization"
         - organization.type: "practice"
         - All other fields use defaults from DEFAULT_CONFIG
      3. Write the file with `JSON.stringify(config, null, 2)`
      4. Output: "Configuration written to {path}"
      5. Output: "Edit the file to set your organization NPI and details, then run: neuron start"

    **src/cli/commands/start.ts:**
    Export a function that registers the `start` command:
    - Description: "Start the Neuron server"
    - Option: `--config, -c <path>` (default: `neuron.config.json`)
    - Action:
      1. Call `loadConfig(options.config)` -- wrapped in try/catch
      2. On ConfigError: `output.error(err.message)` + `process.exit(1)`
      3. On success: `output.info("Configuration loaded")`
      4. Create `SqliteStorage(config.storage.path)` and call `initialize()`
      5. `output.info("Storage initialized: ${config.storage.path}")`
      6. If `config.audit.enabled`: create `AuditLogger(config.audit.path)` and log startup event: `{ category: 'admin', action: 'neuron_start', details: { npi: config.organization.npi } }`
      7. `output.info("Audit logging active: ${config.audit.path}")`
      8. `output.success("Neuron started for ${config.organization.name} (NPI: ${config.organization.npi})")`
      9. For Phase 1, the server just stays alive (no WebSocket yet). Use a simple keepalive: `setInterval(() => {}, 60000)`. Handle SIGINT/SIGTERM to close storage and exit cleanly.

    **src/cli/commands/stop.ts:**
    Export a function that registers the `stop` command:
    - Description: "Stop the Neuron server"
    - Action: For Phase 1, just output "Stop command not yet implemented (server runs in foreground, use Ctrl+C)"

    **src/cli/commands/status.ts:**
    Export a function that registers the `status` command:
    - Description: "Show Neuron server status"
    - Action: For Phase 1, just output "Status command not yet implemented"

    **src/cli/index.ts:**
    Create the Commander program:
    ```typescript
    #!/usr/bin/env node
    import { Command } from 'commander'
    // import and register all commands

    const program = new Command()
    program
      .name('neuron')
      .description('CareAgent organizational boundary server')
      .version('0.1.0')

    // Register each command
    registerInitCommand(program)
    registerStartCommand(program)
    registerStopCommand(program)
    registerStatusCommand(program)

    program.parse()
    ```

    **bin/neuron:**
    Create as a shell script or symlink. If using tsdown build output:
    ```bash
    #!/usr/bin/env node
    import '../dist/cli/index.js'
    ```
    Or simpler: make `bin/neuron` point to `dist/cli/index.js` via package.json `bin` field (already configured in Plan 01). Create `bin/neuron` as:
    ```
    #!/usr/bin/env node
    await import('../dist/cli/index.js')
    ```
    Make it executable: `chmod +x bin/neuron`

    Ensure `src/cli/index.ts` has the shebang `#!/usr/bin/env node` at the top.

    Ensure the data directory (`./data/`) is created automatically by the start command if it doesn't exist (use `fs.mkdirSync(path.dirname(storagePath), { recursive: true })`).
  </action>
  <verify>
    Build the project: `pnpm run build`
    Run `node dist/cli/index.js --help` -- shows all four commands.
    Run `node dist/cli/index.js init --output /tmp/test-neuron.config.json` -- creates config file.
    Run `node dist/cli/index.js start --config /tmp/nonexistent.json` -- fails with clear error and exit code 1.
  </verify>
  <done>
    CLI registers four commands via Commander.js v14. `neuron init` generates starter config. `neuron start` loads config, initializes storage, starts audit logger. Invalid config causes clear error + exit(1). Output is consistent with no emojis.
  </done>
</task>

<task type="auto">
  <name>Task 2: CLI integration tests for startup pipeline</name>
  <files>
    src/cli/cli.test.ts
  </files>
  <action>
    Write integration tests that verify the full CLI startup pipeline.

    **src/cli/cli.test.ts:**

    Use vitest with temp directories (`fs.mkdtempSync`) for isolated test environments.

    Test cases:

    1. **init command creates valid config file:**
       - Run init command programmatically (import the action function, not spawn process)
       - Verify file exists at output path
       - Verify JSON is valid and parseable
       - Verify all required fields present with placeholder values

    2. **start command with valid config succeeds:**
       - Create a valid neuron.config.json in temp dir with a real NPI ("1234567893")
       - Set storage.path and audit.path to temp dir locations
       - Call the start action (mock process.exit, setTimeout)
       - Verify no error thrown
       - Verify storage DB file created
       - Verify audit log file created with startup entry

    3. **start command with invalid config exits with error:**
       - Create config with invalid NPI ("0000000000" -- fails Luhn)
       - Mock process.exit
       - Call start action
       - Verify process.exit called with 1
       - Verify error message mentions NPI

    4. **start command with missing config file exits with error:**
       - Call start with nonexistent path
       - Verify process.exit called with 1
       - Verify error message mentions file path

    5. **start command with malformed JSON exits with error:**
       - Write invalid JSON to a file
       - Call start action
       - Verify process.exit called with 1

    6. **help output lists all four commands:**
       - Call program.helpInformation()
       - Verify output contains "init", "start", "stop", "status"

    7. **start command creates data directory if missing:**
       - Use a storage path in a non-existent subdirectory
       - Verify directory is created automatically

    Clean up temp directories in afterEach.
  </action>
  <verify>
    `pnpm vitest run src/cli/cli.test.ts` -- all tests pass.
    `pnpm vitest run --coverage` -- verify coverage meets 80% thresholds across all modules.
  </verify>
  <done>
    CLI integration tests verify the full startup pipeline: init creates config, start validates config and initializes all subsystems, invalid config fails cleanly. All seven test cases pass. Coverage thresholds met across the project.
  </done>
</task>

</tasks>

<verification>
- `neuron --help` shows init, start, stop, status commands
- `neuron init` generates valid starter config
- `neuron start` with valid config: loads config, creates DB, creates audit log, reports success
- `neuron start` with invalid config: clear error message, exit code 1
- `neuron start` with bad NPI: specific NPI validation error
- All tests pass, coverage thresholds met
</verification>

<success_criteria>
- Commander.js v14 CLI with four registered commands
- `neuron start` exercises full startup pipeline (config -> storage -> audit)
- Invalid config prevents startup with clear field-level errors
- `neuron init` generates a starter config file
- Integration tests verify success and failure paths
- All Phase 1 success criteria are met when combined with Plans 01-03
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-04-SUMMARY.md`
</output>
