---
phase: 05-local-discovery
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/types/config.ts
  - src/config/defaults.ts
  - src/discovery/index.ts
  - src/discovery/service.ts
  - src/discovery/types.ts
  - src/discovery/discovery.test.ts
  - package.json
autonomous: true
requirements: [DISC-01, DISC-02, DISC-03]

must_haves:
  truths:
    - "DiscoveryService.start() publishes a _careagent-neuron._tcp mDNS service with correct TXT records"
    - "DiscoveryService.stop() sends goodbye packets and cleans up the mDNS responder"
    - "When localNetwork.enabled is false, start() is a no-op (no mDNS activity)"
    - "TXT records contain npi, ver, and ep keys with correct values"
    - "Service instance name includes organization NPI for multi-Neuron LAN uniqueness"
  artifacts:
    - path: "src/discovery/service.ts"
      provides: "DiscoveryService class with start/stop lifecycle"
      exports: ["DiscoveryService"]
    - path: "src/discovery/types.ts"
      provides: "DiscoveryConfig type and TXT record type definitions"
      exports: ["DiscoveryConfig"]
    - path: "src/discovery/index.ts"
      provides: "Barrel exports for discovery module"
      exports: ["DiscoveryService", "DiscoveryConfig"]
    - path: "src/types/config.ts"
      provides: "Extended localNetwork config with serviceType and instanceName"
    - path: "src/discovery/discovery.test.ts"
      provides: "TDD tests for DiscoveryService"
  key_links:
    - from: "src/discovery/service.ts"
      to: "bonjour-service"
      via: "import Bonjour from 'bonjour-service'"
      pattern: "new Bonjour\\(\\)"
    - from: "src/discovery/service.ts"
      to: "src/discovery/types.ts"
      via: "DiscoveryConfig import"
      pattern: "import.*DiscoveryConfig"
---

<objective>
Create the DiscoveryService module that manages mDNS/DNS-SD advertisement lifecycle for local network CareAgent discovery.

Purpose: Encapsulate bonjour-service behind a testable DiscoveryService class that advertises `_careagent-neuron._tcp` with TXT records (NPI, protocol version, endpoint URL) and handles graceful shutdown with goodbye packets. This is the core building block that Plan 02 wires into the Neuron startup/shutdown lifecycle.

Output: `src/discovery/` module with DiscoveryService class, types, barrel exports, and TDD tests. Extended NeuronConfig localNetwork section. `bonjour-service` installed as production dependency.
</objective>

<execution_context>
@/Users/medomatic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medomatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-local-discovery/05-RESEARCH.md
@.planning/phases/05-local-discovery/05-CONTEXT.md
@src/types/config.ts
@src/config/defaults.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install bonjour-service and extend NeuronConfig schema</name>
  <files>package.json, src/types/config.ts, src/config/defaults.ts</files>
  <action>
Install bonjour-service as a production dependency:
```bash
pnpm add bonjour-service
```

Extend the `localNetwork` section in `src/types/config.ts` NeuronConfigSchema:
```typescript
localNetwork: Type.Object({
  enabled: Type.Boolean({ default: false }),
  serviceType: Type.String({ default: 'careagent-neuron' }),
  protocolVersion: Type.String({ default: 'v1.0' }),
}),
```

- `enabled` — master toggle for mDNS advertisement (existing, keep default false)
- `serviceType` — DNS-SD service type (becomes `_careagent-neuron._tcp`). Default covers DISC-01. Configurable for testing.
- `protocolVersion` — semantic version advertised in TXT records per user decision. Default `v1.0`.

Update `src/config/defaults.ts` to include the new fields:
```typescript
localNetwork: {
  enabled: false,
  serviceType: 'careagent-neuron',
  protocolVersion: 'v1.0',
},
```

Do NOT add fields that the DiscoveryService derives at runtime (like endpoint URL or instance name — those come from other config sections).
  </action>
  <verify>
`pnpm build` succeeds. Existing tests pass (`pnpm test`). `bonjour-service` appears in package.json dependencies.
  </verify>
  <done>
NeuronConfig has localNetwork.serviceType and localNetwork.protocolVersion fields with correct defaults. bonjour-service is installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DiscoveryService with TDD (RED then GREEN)</name>
  <files>src/discovery/types.ts, src/discovery/service.ts, src/discovery/index.ts, src/discovery/discovery.test.ts</files>
  <action>
**Types first** (`src/discovery/types.ts`):

```typescript
/** Configuration for the DiscoveryService */
export interface DiscoveryConfig {
  enabled: boolean
  serviceType: string
  protocolVersion: string
  organizationNpi: string
  serverPort: number
  endpointUrl: string
}
```

The `DiscoveryConfig` is assembled at the integration point (start.ts) from NeuronConfig fields — it's NOT a TypeBox schema, just a plain interface.

**TDD RED phase** — Write tests first in `src/discovery/discovery.test.ts`:

Mock `bonjour-service` at the module level using `vi.mock('bonjour-service', ...)`. The mock should track:
- Whether `publish()` was called and with what arguments
- Whether `unpublishAll()` was called
- Whether `destroy()` was called

Test cases:
1. `start() when enabled publishes service with correct type and port` — verify publish called with `{ name: 'neuron-{NPI}', type: 'careagent-neuron', port: 3000, txt: { npi, ver, ep } }`
2. `start() when enabled sets correct TXT records` — verify txt object has `npi` (10-digit NPI), `ver` ('v1.0'), `ep` (full WebSocket URL)
3. `start() when disabled is a no-op` — verify publish NOT called, no Bonjour instance created
4. `stop() calls unpublishAll then destroy` — verify cleanup sequence
5. `stop() when never started is safe` — no errors thrown
6. `service instance name uses NPI for uniqueness` — verify name is `neuron-{NPI}`
7. `TXT record keys follow RFC 6763 (<=9 chars)` — verify all keys: `npi` (3), `ver` (3), `ep` (2)

Run tests — they should FAIL (RED). Commit: `test(05-01): add failing tests for DiscoveryService`

**TDD GREEN phase** — Implement `src/discovery/service.ts`:

```typescript
import Bonjour, { type Service } from 'bonjour-service'
import type { DiscoveryConfig } from './types.js'

export class DiscoveryService {
  private bonjour: InstanceType<typeof Bonjour> | null = null
  private service: Service | null = null

  constructor(private readonly config: DiscoveryConfig) {}

  async start(): Promise<void> {
    if (!this.config.enabled) return

    this.bonjour = new Bonjour()
    this.service = this.bonjour.publish({
      name: `neuron-${this.config.organizationNpi}`,
      type: this.config.serviceType,
      port: this.config.serverPort,
      txt: {
        npi: this.config.organizationNpi,
        ver: this.config.protocolVersion,
        ep: this.config.endpointUrl,
      },
    })
  }

  async stop(): Promise<void> {
    if (!this.bonjour) return

    return new Promise<void>((resolve) => {
      this.bonjour!.unpublishAll(() => {
        this.bonjour!.destroy()
        this.bonjour = null
        this.service = null
        resolve()
      })
    })
  }
}
```

Key implementation details:
- Constructor takes DiscoveryConfig (assembled from NeuronConfig at call site)
- `start()` early-returns if `!enabled` — DISC-03 no-op behavior
- Instance name: `neuron-{NPI}` for multi-Neuron LAN uniqueness (per research pitfall 5)
- TXT keys: `npi`, `ver`, `ep` — all <=9 chars per RFC 6763 Section 6.4
- `stop()` calls `unpublishAll()` (sends goodbye packets per RFC 6762) then `destroy()` (closes socket)
- `stop()` is safe to call even if `start()` was never called

**Barrel exports** (`src/discovery/index.ts`):
```typescript
export { DiscoveryService } from './service.js'
export type { DiscoveryConfig } from './types.js'
```

Run tests — they should PASS (GREEN). Commit: `feat(05-01): implement DiscoveryService with mDNS advertisement`
  </action>
  <verify>
`pnpm test src/discovery/discovery.test.ts` — all 7 tests pass. `pnpm build` succeeds. `pnpm test` (full suite) passes with no regressions.
  </verify>
  <done>
DiscoveryService class exists with start/stop lifecycle. TDD tests verify: correct service type, TXT records, no-op when disabled, graceful cleanup, and RFC 6763 key length compliance. All tests pass.
  </done>
</task>

</tasks>

<verification>
- [ ] `bonjour-service` in package.json dependencies
- [ ] NeuronConfig localNetwork has `enabled`, `serviceType`, `protocolVersion` fields
- [ ] defaults.ts matches schema defaults
- [ ] DiscoveryService.start() publishes `_careagent-neuron._tcp` with correct TXT records
- [ ] DiscoveryService.stop() sends goodbye packets (unpublishAll + destroy)
- [ ] Disabled mode is a clean no-op
- [ ] TXT record keys are `npi`, `ver`, `ep` (all <=9 chars)
- [ ] Service instance name is `neuron-{NPI}`
- [ ] All tests pass (`pnpm test`)
- [ ] Build succeeds (`pnpm build`)
</verification>

<success_criteria>
The discovery module exists as a standalone, tested service class ready to be wired into the Neuron lifecycle (Plan 02). bonjour-service is installed. NeuronConfig schema is extended. All TDD tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/05-local-discovery/05-01-SUMMARY.md`
</output>
